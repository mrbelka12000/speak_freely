<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microphone Audio Processing and Upload</title>
</head>
<body>
<h1>Microphone Audio Processing and Upload</h1>
<button id="start">Start</button>
<button id="stop">Stop</button>
<audio id="audioPlayback" controls></audio>

<script>
    let audioContext;
    let microphoneStream;
    let mediaRecorder;
    let recordedChunks = [];

    document.getElementById("start").addEventListener("click", async () => {
        // Step 1: Request microphone access
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            handleMicrophoneStream(stream);
        } catch (error) {
            console.error('Error accessing the microphone:', error);
        }
    });

    document.getElementById("stop").addEventListener("click", () => {
        stopRecording();
    });

    function handleMicrophoneStream(stream) {
        // Step 2: Create an AudioContext and connect the stream to it
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        microphoneStream = audioContext.createMediaStreamSource(stream);

        // Optional: Create a GainNode to control volume
        const gainNode = audioContext.createGain();
        microphoneStream.connect(gainNode);
        gainNode.connect(audioContext.destination);

        // Step 3: Setup MediaRecorder for recording the stream
        mediaRecorder = new MediaRecorder(stream);

        // Collect audio data chunks as the recording happens
        mediaRecorder.ondataavailable = event => {
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        };

        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
            const audioUrl = URL.createObjectURL(audioBlob);
            const audioPlayback = document.getElementById('audioPlayback');
            audioPlayback.src = audioUrl;
            recordedChunks = []; // Clear the chunks for the next recording

            // Upload the audio file to the server
            await uploadAudioFile(audioBlob);
        };

        // Start recording
        mediaRecorder.start();
    }

    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
            mediaRecorder.stop();
        }
        if (audioContext) {
            audioContext.close();
        }
    }

    async function uploadAudioFile(blob) {
        // Create FormData to hold the file data
        const formData = new FormData();
        formData.append('file', blob, 'recording.webm'); // Name 'audiofile', filename 'recording.webm'

        try {
            // Send the FormData using fetch() to your server
            const response = await fetch('http://localhost:8081/api/v1/transcript', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                console.log('File uploaded successfully!');
            } else {
                console.error('File upload failed:', response.statusText);
            }
        } catch (error) {
            console.error('Error uploading file:', error);
        }
    }
</script>
</body>
</html>
